# GitLab CI/CD Pipeline for Ovie Programming Language
# This pipeline builds, tests, and releases Ovie across multiple platforms

stages:
  - test
  - build
  - release
  - deploy

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUST_VERSION: "1.75"

# Cache configuration
.cache_template: &cache_template
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .cargo/
      - target/

# Test stage
test:
  stage: test
  image: rust:$RUST_VERSION
  <<: *cache_template
  script:
    - rustc --version && cargo --version
    - cargo check --workspace
    - cargo test --lib --workspace
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID

# Build stage - Linux
build:linux:
  stage: build
  image: rust:$RUST_VERSION
  <<: *cache_template
  script:
    - rustup target add x86_64-unknown-linux-gnu
    - cargo build --release --target x86_64-unknown-linux-gnu --workspace
    - mkdir -p artifacts/linux-x64
    - cp target/x86_64-unknown-linux-gnu/release/ovie artifacts/linux-x64/
    - cp target/x86_64-unknown-linux-gnu/release/oviec artifacts/linux-x64/
    - cp README.md LICENSE artifacts/linux-x64/
    - cp -r docs examples artifacts/linux-x64/
    - |
      cat > artifacts/linux-x64/install.sh << 'EOF'
      #!/bin/bash
      echo "Installing Ovie Programming Language..."
      mkdir -p ~/.local/bin
      cp ovie ~/.local/bin/
      cp oviec ~/.local/bin/
      chmod +x ~/.local/bin/ovie ~/.local/bin/oviec
      echo "Ovie installed successfully!"
      echo "Make sure ~/.local/bin is in your PATH"
      echo "Run 'ovie --help' to get started."
      EOF
    - chmod +x artifacts/linux-x64/install.sh
    - cd artifacts && tar -czf ovie-$CI_COMMIT_TAG-linux-x64.tar.gz linux-x64
  artifacts:
    paths:
      - artifacts/ovie-*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build stage - Windows (using cross-compilation)
build:windows:
  stage: build
  image: rust:$RUST_VERSION
  <<: *cache_template
  before_script:
    - apt-get update && apt-get install -y mingw-w64
    - rustup target add x86_64-pc-windows-gnu
  script:
    - cargo build --release --target x86_64-pc-windows-gnu --workspace
    - mkdir -p artifacts/windows-x64
    - cp target/x86_64-pc-windows-gnu/release/ovie.exe artifacts/windows-x64/
    - cp target/x86_64-pc-windows-gnu/release/oviec.exe artifacts/windows-x64/
    - cp README.md LICENSE artifacts/windows-x64/
    - cp -r docs examples artifacts/windows-x64/
    - |
      cat > artifacts/windows-x64/install.bat << 'EOF'
      @echo off
      echo Installing Ovie Programming Language...
      if not exist "%USERPROFILE%\.local\bin" mkdir "%USERPROFILE%\.local\bin"
      copy ovie.exe "%USERPROFILE%\.local\bin\" >nul 2>&1
      copy oviec.exe "%USERPROFILE%\.local\bin\" >nul 2>&1
      echo Ovie installed successfully!
      echo Add %USERPROFILE%\.local\bin to your PATH if not already added.
      echo Run 'ovie --help' to get started.
      pause
      EOF
    - cd artifacts && zip -r ovie-$CI_COMMIT_TAG-windows-x64.zip windows-x64
  artifacts:
    paths:
      - artifacts/ovie-*.zip
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Performance benchmarks
benchmark:
  stage: test
  image: rust:$RUST_VERSION
  <<: *cache_template
  script:
    - cargo build --release --bin benchmark
    - cargo run --release --bin benchmark
  artifacts:
    reports:
      performance: benchmark-results.json
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# Security scan
security:
  stage: test
  image: rust:$RUST_VERSION
  script:
    - cargo install cargo-audit
    - cargo audit
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_MERGE_REQUEST_IID
  allow_failure: true

# Release stage
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - build:linux
    - build:windows
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Ovie Programming Language $CI_COMMIT_TAG'
    description: |
      # Ovie Programming Language $CI_COMMIT_TAG
      
      ## Installation
      
      ### Quick Install
      
      **Linux:**
      ```bash
      curl -sSL https://gitlab.com/ovie1/ovie/-/raw/main/install.sh | bash
      ```
      
      **Windows (PowerShell):**
      ```powershell
      iwr -useb https://gitlab.com/ovie1/ovie/-/raw/main/install.ps1 | iex
      ```
      
      ### Manual Installation
      
      Download the appropriate archive below and run the included install script.
      
      ## What's New
      
      - Complete Ovie programming language implementation
      - Cross-platform support (Windows, Linux, macOS)
      - CLI toolchain with project scaffolding
      - Multiple compilation backends (IR, WASM)
      - Aproko assistant engine for code analysis
      - Comprehensive documentation and examples
      
      ## Quick Start
      
      ```bash
      ovie new my-project
      cd my-project
      ovie run
      ```
    assets:
      links:
        - name: 'Linux x64'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/artifacts/ovie-$CI_COMMIT_TAG-linux-x64.tar.gz?job=build:linux'
        - name: 'Windows x64'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/artifacts/ovie-$CI_COMMIT_TAG-windows-x64.zip?job=build:windows'
  rules:
    - if: $CI_COMMIT_TAG

# Pages deployment for documentation
pages:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache pandoc
  script:
    - mkdir public
    - cp -r docs/* public/
    - |
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
          <title>Ovie Programming Language</title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; }
              .header { text-align: center; margin-bottom: 40px; }
              .nav { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 40px; }
              .nav a { padding: 10px 20px; background: #f0f0f0; text-decoration: none; border-radius: 5px; }
              .nav a:hover { background: #e0e0e0; }
              .content { max-width: 800px; margin: 0 auto; }
          </style>
      </head>
      <body>
          <div class="header">
              <h1>ðŸš€ Ovie Programming Language</h1>
              <p>A modern, safe, and AI-friendly programming language</p>
          </div>
          <div class="nav">
              <a href="getting-started.html">Getting Started</a>
              <a href="language-guide.html">Language Guide</a>
              <a href="installation.html">Installation</a>
              <a href="examples.html">Examples</a>
              <a href="aproko.html">Aproko Assistant</a>
              <a href="internals.html">Internals</a>
          </div>
          <div class="content">
              <h2>Welcome to Ovie</h2>
              <p>Ovie is an open-source programming language designed to be:</p>
              <ul>
                  <li><strong>Safe</strong> - Memory safety and ownership rules prevent common bugs</li>
                  <li><strong>AI-Friendly</strong> - Natural syntax that works well with AI assistants</li>
                  <li><strong>Modern</strong> - Built with modern language design principles</li>
                  <li><strong>Cross-Platform</strong> - Runs on Windows, macOS, and Linux</li>
              </ul>
              
              <h3>Quick Start</h3>
              <pre><code># Install Ovie
curl -sSL https://gitlab.com/ovie1/ovie/-/raw/main/install.sh | bash

# Create a new project
ovie new hello-world
cd hello-world

# Run your project
ovie run</code></pre>
              
              <h3>Example Code</h3>
              <pre><code>// Hello World in Ovie
seeAm "Hello, World!";

// Variables and functions
fn greet(name) {
    seeAm "Hello, " + name + "!";
}

name = "Ovie";
greet(name);</code></pre>
          </div>
      </body>
      </html>
      EOF
    # Convert markdown files to HTML
    - for file in docs/*.md; do pandoc "$file" -o "public/$(basename "$file" .md).html"; done
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Docker image build
docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - |
      cat > Dockerfile << 'EOF'
      FROM rust:1.75 as builder
      WORKDIR /app
      COPY . .
      RUN cargo build --release --workspace
      
      FROM debian:bookworm-slim
      RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
      COPY --from=builder /app/target/release/ovie /usr/local/bin/
      COPY --from=builder /app/target/release/oviec /usr/local/bin/
      COPY --from=builder /app/docs /usr/share/ovie/docs
      COPY --from=builder /app/examples /usr/share/ovie/examples
      CMD ["ovie", "--help"]
      EOF
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG